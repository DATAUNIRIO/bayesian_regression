---
title: "Bayesian modeling and prediction for movies"
output: 
  html_document: 
    fig_height: 4
    highlight: pygments
    theme: spacelab
---

## Setup

### Load packages

```{r load-packages, message = FALSE}
library(ggplot2)
library(dplyr)
library(statsr)
library(BAS)
library(pander)
library(grid)
library(gridExtra)
```

### Load data

```{r load-data}
load("movies.Rdata")
```

* * *

## Data

In the `movies` dataset, there is 651 **randomly sampled** movies which were released in United States movie theater in the period of 1970-2014. The data was obtained from [Rotten Tomatoes](https://www.rottentomatoes.com/) and [IMDB](https://www.imdb.com/). The dataset contains 32 features of each movie, including genre, MPAA rating, production studio, and whether they recieved Oscar nominations.

Even though there is no detailed information about the exact sampling methods used, the movies included in this dataset were randomly sampled from the above two mentioned sources and no bias were created by the sampling method so we can assume that the results obtained can be **generalized to all U.S movies released between 1970 and 2014**. On the other hand, because this is an observational study, **the relationships that could be find from this data indicate association, but _not causation_**

* * *
## Data wrangling  
    
In order to develop the Bayesian regression model to predict `audience_score` from the explanatory variables, we will use the function `mutate` to create the new variables as follows:

  * `feature_film`: with two levels:
    + 'yes': if `title_type` is 'Feature Film'
    + 'no': otherwise
    
```{r feature}
movies <- movies%>%
        mutate(feature_film = factor(ifelse(title_type == 'Feature Film', 'yes', 'no')))
```

  * `drama`: with two levels:
    + 'yes': if `genre` is 'Drama'
    + 'no': otherwise

```{r drama}
movies <- movies%>%
        mutate(drama = factor(ifelse(genre == 'Drama', 'yes', 'no')))
```

  * `mpaa_rating_R`: with two levels:
    + 'yes': if `mpaa_rating` is 'R'
    + 'no': otherwise

```{r mpaa}
movies <- movies%>%
        mutate(mpaa_rating_R = factor(ifelse(mpaa_rating == 'R', 'yes', 'no')))
```

  * `oscar_season`: with two levels:
    + 'yes': if `thtr_rel_month` is 'November' or 'October' or 'December'
    + 'no': otherwise

```{r oscar}
movies <- movies%>%
        mutate(oscar_season = factor(ifelse(thtr_rel_month == 10|
                                       thtr_rel_month == 11|
                                       thtr_rel_month == 12,
                                                            'yes', 'no')))
```

  * `summer_season`: with two levels:
    + 'yes': if `thtr_rel_month` is 'May' or 'June' or 'July' or 'August'
    + 'no': otherwise

```{r summer}
movies <- movies%>%
        mutate(summer_season = factor(ifelse(thtr_rel_month == 5|
                                       thtr_rel_month == 6|
                                       thtr_rel_month == 7|
                                       thtr_rel_month == 8,
                                                            'yes', 'no')))
```

After creating the new variables, we will select the variables requiered for the analysis:

```{r selecting}
movies_final <- movies%>%
                  select(feature_film, drama, runtime, mpaa_rating_R, 
                         thtr_rel_year, oscar_season, summer_season, imdb_rating,
                         imdb_num_votes, critics_score, best_pic_nom, best_pic_win,
                         best_actor_win, best_actress_win, best_dir_win, top200_box, audience_score)
```

* * *

## Exploratory data analysis
  
### Relation between new exploratory and response variables:

First of all, we will investigate which is the relationship between the response variable `audience_score` and the new exploratory variables created. In doing so, we will create summary statistic tables and side-by-side boxplot:

```{r feature_plot, fig.height= 8, fig.width=8}
p1 <- ggplot(movies_final, aes(x=feature_film, y = audience_score, fill=feature_film))+
  geom_boxplot(alpha = 0.7)+
  theme_minimal()+
  scale_fill_brewer(palette="Set2")+
  labs(x = "Feature Film", y= "Audience Score")+ 
  theme(axis.text.x=element_text(angle=90, hjust = 1, vjust = 0))+
  theme(legend.position="none")

p2 <- ggplot(movies_final, aes(x=drama, y = audience_score, fill=drama))+
  geom_boxplot(alpha = 0.7)+
  theme_minimal()+
  scale_fill_brewer(palette="Set3")+
  labs(x = "Drama", y= "Audience Score")+ 
  theme(axis.text.x=element_text(angle=90, hjust = 1, vjust = 0))+
  theme(legend.position="none")

p3<- ggplot(movies_final, aes(x=mpaa_rating_R, y = audience_score, fill=mpaa_rating_R))+
  geom_boxplot(alpha = 0.7)+
  theme_minimal()+
  scale_fill_brewer(palette="Set1")+  
  labs(x = "MPAA Rating R", y= "Audience Score")+ 
  theme(axis.text.x=element_text(angle=90, hjust = 1, vjust = 0))+
  theme(legend.position="none")

p4 <- ggplot(movies_final, aes(x=oscar_season, y = audience_score, fill=oscar_season))+
  geom_boxplot(alpha = 0.7)+
  theme_minimal()+
  scale_fill_brewer(palette="Dark2")+   
  labs(x = "Oscar season", y= "Audience Score")+ 
  theme(axis.text.x=element_text(angle=90, hjust = 1, vjust = 0))+
  theme(legend.position="none")

p5 <- ggplot(movies_final, aes(x=summer_season, y = audience_score, fill=summer_season))+
  geom_boxplot(alpha = 0.7)+
  theme_minimal()+
  scale_fill_brewer(palette="RdBu")+   
  labs(x = "Summer season", y= "Audience Score")+ 
  theme(axis.text.x=element_text(angle=90, hjust = 1, vjust = 0))+
  theme(legend.position="none")


grid.arrange(p1, p2, p3, p4, p5, nrow = 3)
```

#### - `feature film`


```{r summary feature}
table_feature <- movies_final %>%
                    tbl_df%>%
                    group_by(feature_film)%>%
                    dplyr::summarize(n = n(), Mean = mean(round(mean(audience_score), 2)), Sd = sd(audience_score))
pandoc.table(table_feature)
```

From the table and the plots, we can observe that:  
  
 * Even though there are only 60 non-feature films vs. 591 feature films, a potential relationship between `feature_film` and `audience_score` is present in this dataset due to the fact that non feature films appear to have an `audience_score` mean of 20.5 point higher than feature films. 
 * Taking into consideration the variance of both groups, it is neccesary to use inferential tools to distinguish if this difference is statistically significant. 


#### - `drama`:

```{r summary drama}
table_drama <- movies_final %>%
                    tbl_df%>%
                    group_by(drama)%>%
                    dplyr::summarize(n = n(), Mean = mean(round(mean(audience_score), 2)), Sd = sd(audience_score))
pandoc.table(table_drama)
```

From the plot and the table, we can observe the following:  

 * There are 346 movies that belong to the category drama and 305 that do not.   
 * Contrary to what we observed with `feature_film` variable, there is not clear relationship between `drama` and `audience_score` as the mean of both groups is similar (59.73 vs. 65.35). 

#### - `mpaa_rating_R`:

```{r summary rating}
table_rating <- movies_final %>%
                    tbl_df%>%
                    group_by(mpaa_rating_R)%>%
                    dplyr::summarize(n = n(), Mean = mean(round(mean(audience_score), 2)), Sd = sd(audience_score))
pandoc.table(table_rating)
```

From the plot and the table, we learnt that:  
  
 * The variable `mpaa_rating` shows no relationship with `audience_score`.  
 * Not only we can see that half of the movies (329) belongs to the category 'R' of MPAA Rating, but also the mean of `audience_score` is equal in both groups (62.04 vs. 62.69) as well as the variance (20.16 vs. 20.32).


#### - `oscar_season`:

```{r summary oscar}
table_oscar <- movies_final %>%
                    tbl_df%>%
                    group_by(oscar_season)%>%
                    dplyr::summarize(n = n(), Mean = mean(round(mean(audience_score), 2)), Sd = sd(audience_score))
pandoc.table(table_oscar)
```

From the plot and the table, we observe that:  
  
 * The variable `oscar_season` do not show a evident relationship with `audience_score`.  
 * There is fewer movies released within Oscar season (191) that outside it (460).
 * The mean of `audience_score` is similar in both groups (63.69 vs. 61.81) as well as the variance (20.46 vs. 20.12).


#### - `summer_season`:

```{r summary summer}
table_summer <- movies_final %>%
                    tbl_df%>%
                    group_by(summer_season)%>%
                    dplyr::summarize(n = n(), Mean = mean(round(mean(audience_score), 2)), Sd = sd(audience_score))
pandoc.table(table_summer)
```

From the plot and the table, we observe that:  
  
 * The variable `summer_season` do not show a evident relationship with `audience_score`.  
 * There is fewer movies released within summer season (208) that outside it (443).
 * The mean of `audience_score` is similar in both groups (61.81 vs. 62.62) as well as the variance (19.91 vs. 20.39).

From the exploratory analysis performed, we can speculate that the new created variable `feature_film` would have the strongest relationship with our response variable `audience_score` while the other new variables created could have weak or no relationship.

Last, we need to point out that there are two numerical variables (`imdb_rating` and `critics_score`) that could have a correlation with the response variable `audience_score` due to the fact that the three of them serve to the purpose to rate the movies.

We will check this by ploting these variables and calculating the correlation using the function `cor`: 

** `audience_score` vs. `imdb_rating` **

```{r fig.width=5, fig.height=3}
ggplot(movies_final, aes(x=audience_score, y=imdb_rating))+
  theme_minimal()+
  geom_point()+
  geom_smooth()+
  labs(x = "Score in Rotten Tomatoes", y = "Rating in Imdb")
   
```

```{r correlation calc2}
cor(movies$audience_score, movies$imdb_rating)
```

As it can be observed from the plot and the correlation coefficient, there is a high correlation between both variables. 
  
** `audience_score` vs. `critics_score` **

```{r fig.width=5, fig.height=3}
ggplot(movies_final, aes(x=audience_score, y=critics_score))+
  theme_minimal()+
  geom_point()+
  geom_smooth()+
  labs(x = "Score in Rotten Tomatoes", y = "Rating in Imdb")
   
```
```{r correlation calc}
cor(movies$audience_score, movies$critics_score)
```

In this case, the plot and the correlation coefficient show a less strong correlation between both variables than in the case of `imdb_rating`, but it is still high. 

* * *
## Modeling

We will now proceed to conduct a Bayesian regression using the `BAS` package. We will use Bayesian Model Average (BMA) and  Zellner-Siow Cauchy prior along with an uniform model prior to assign equal probabilities to all models. Regarding the option method, we will use "MCMC" (Markov chain Monte Carlo) that improves the  model search efficiency.

Fist of all, we will discard any rows with `NAs`:

```{r}
movies_final <- movies_final %>%
      filter(complete.cases(.))
```

The code below creates the full Bayesian model:

```{r bayesian}
movies_bas <- bas.lm(audience_score ~ .,
                     data = movies_final,
                     method = "MCMC",
                     prior = "ZS-null",
                     modelprior = uniform())
```

We will now print the marginal inclusion probabilities obtained for the model:

```{r summary}
movies_bas
```

After that, we can use the function `summary`  

```{r summarybas}
summary(movies_bas)
```

to see the top 5 models with the zero-one indicators for variable inclusion. It is also displayed a column with the Bayes factor ($BF$) for each model to the highest probability model, the posterior probabilities of the models ($PostProbs$), the $R^2$ of the models, the dimension of the models ($dim$) and the log marginal likelihood ($logmarg$) under the selected prior distribution.

Last, we can make use of the function `image`  


```{r image, fig.height=6, fig.width=6}
image(movies_bas, rotate=F)
```
  
to visualize the Log Posterior Odds and Model Rank. In the picture above, each row correspond to each variable included in the full model as well as one extra row for the intercept. In each column, we can see all possible models ($2^{16}$ because we have 16 variables included) sorted by their posterior probability from the best to worst rank on the top (from left to right). 


> From the model and the image above, we can see that:  
>    * `imdb_rating` has a marginal probability of 1, and appears in all five top models  
>    * `critics_score` has a marginal probability of 0.88091 and also appears in all five top models
>    * `runtime` has a marginal probability of 0.46413 and appears in the two of the five top models (second and fifth model)
>    * the intercept also has a marginal probability of 1, and appears in all five top models
    
According to this, the best model includes the intercept, `imdb_rating`, `critics_score` and `runtime`

#### Posterior Distributions of Coefficients

We can now obtain the coefficients estimates and standard deviations under BMA in order to be able to examine the marginal distributions for intercept, `imdb_rating`, `critics_score` and `runtime` coefficients. To do so, we will use the function `coef` and plot them using `plot`:  


```{r coefficients}
coef_movies <- coef(movies_bas)

par(mfrow=c(2,2))
plot(coef_movies, subset = c(1, 4, 9, 11), ask=F)
```

The vertical line corresponds to the posterior probability that the coefficient equals to 0. On the other hand, the shaped curve shows the density of posiible values where the coefficient is non-zero. It is worthy to mention that the height of the line is scaled to its probability. This implies that intercept and `imbd_rating` show no line denoting non-zero probability, `critics_score` has 90% probability of not being zero while `runtime` has only 50%.

Last, we can obtain credible intervals for coefficients using `confint` method:

```{r cin}
confint(coef_movies)
```

#### Graphical Summaries

`BAS` package provides us with an easy way to get graphical summaries for our model just using the function `plot` and the `which` option

 **Residual vs. fitted plot**
```{r residuals, fig.height=4}
plot(movies_bas, which = 1, ask=F)
```

We can observe here a plot of the "Residuals vs. Fitted values"" under BMA. Ideally, we will expect to not see outliers or non-constant variance. However, in this case we can not see that there is a constant spead over the prediction and moreover, there are three outliers. 

 **Model probabilities**
```{r prob, fig.height=4}
plot(movies_bas, which = 2, ask=F)
```

This plot displays the cumulative probability of the models in the order that they are sampled. This plot shows that the cumulative probability starts to level off after 1000 model trials as each additional model adds only a small increment to the cumulative probability. The model search stops at ~6500 instead of enumerations of 2^16 combinations.

 **Model complexity**
```{r compl, fig.height=4}
plot(movies_bas, which = 3, ask=F)
```
This plot shows the dimension of each model, that is the number of regression coefficients including the intercept versus the log of the marginal likelihood of the model. In this case, we can see that highest log marginal can be reached from 2 to 12 dimensions. 


 **Marginal inclusion probabilities**
```{r marg, fig.height=4}
plot(movies_bas, which = 4, ask=F, cex.lab=0.5)
```

 In this case, we can observe the marginal posterior inclusion probabilities for each of the covariates, with marginal posterior inclusion probabilities that are greater than 0.5 shown in red (important variables for explaining the data and prediction). In the graph, we can see what it was show already before that imbd_rating and critics_score contribute to the final scores.

* * *
## Prediction

Now, we can test the predictive capability of the developed model using two movies:  "Zootropolis" released in 2016. The corresponding information was obtained from the [IMDB website](https://www.imdb.com/title/tt2948356/?ref_=nv_sr_1) and [RottenTomatoes](https://www.rottentomatoes.com/m/zootopia) to be consistent with the analysis data. 

```{r iron_man2}
zootropolis <- data.frame(feature_film = "yes", drama="no", 
                          runtime=108, mpaa_rating_R = "no", 
                          thtr_rel_year = 2016, oscar_season = "no", 
                          summer_season = "no", imdb_rating=8.0,
                          imdb_num_votes = 345433, critics_score=98, 
                          best_pic_nom = "yes", best_pic_win = "yes",
                          best_actor_win = "no", best_actress_win = "no",
                          best_dir_win = "yes", top200_box = "no")

predict_1 <- predict(movies_bas, zootropolis, estimator="BMA", interval = "predict", se.fit=TRUE)

predict_1$Ybma
```

The true `audience_score` according to RottenTomatoes is 92, which is pretty close to what our model predicted.


* * *

After performing the Bayesian analysis approach, we can conclude that the `audience_score` of a movie can be predicted. Even though the BMA takes into account all variables, `imdb_rating` and `critics_score` appeared to be the most important predictors, even though that this two variables showed a strong correlation with our response variable and they could be weighted heavily because of this. 

However, it is important to highlight that more information is needed to improve the accuracy of the prediction, as well as a potential transformation of some of the numerical variables, as we saw previously that there were some outliers and 
there was not a constant spread in the prediction. 